---
title: "Regresja kwantylowa"
author: "A.Brodecka"
date: "29 kwietnia 2017"
output:
  html_document:
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
```

```{r, echo = FALSE, include= FALSE}
setwd('/media/ola/EEAABE9FAABE642D/metylacja')
source('/media/ola/EEAABE9FAABE642D/metylacja/metR/Rcodes/function_preprocessing.R')
source('/media/ola/EEAABE9FAABE642D/metylacja/metR/Rcodes/libraries.R')


data <- readRDS('dane/to_analysis.rds')
data %>% mutate(met = numCs/(numTs + numCs)) -> data
dataa <- data

options(scipen=10000)

```

## Podzia³ po gapach (max = 100)

```{r}

data <- create_tiles(data, 100) 
data %>% group_by(tiles, group) %>% summarise(mean_met = mean(met), n = n(), n2 = n()*n(),
                                              n_sqrt = n()^(-1/2), n_sqrt3 = n()^(-1/3), n_ =n()^(-1)) %>% 
  spread(group, mean_met) %>% mutate(diff_met = abs(EK - EU)) -> data_mets

data_mets %>% group_by(n) %>% summarise(q90 = quantile(diff_met, probs = 0.9 )) -> quantile_90s

head(data_mets)

```


### Regresja z kwantylem 0.9

```{r}
fit1s <- rq(diff_met~n,tau=.90, data = data_mets)
summ1s <- summary(fit1s)

print(summ1s)

wynik <- data.frame(n = 1:20, est = summ1s$coefficients[1,1] + 1:20 * summ1s$coefficients[2,1])
wynik
```


```{r}
fit2s <- rq(diff_met~n + n2,tau=.90, data = data_mets)
summ2s <- summary(fit2s)

print(summ2s)

wynik <- data.frame(n = 1:20, est = summ2s$coefficients[1,1] + 1:20 * summ2s$coefficients[2,1] + (1:20)^2 * summ2s$coefficients[3,1])

wynik

```

```{r}
fit3s <- rq(diff_met~ -1 + n_sqrt,tau=.90, data = data_mets)
summ3s <- summary(fit3s)

print(summ3s)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1/2) * summ3s$coefficients[1,1])

wynik

```
```{r}
fit4s<- rq(diff_met~ -1 + n_sqrt3,tau=.90, data = data_mets)
summ4s <- summary(fit4s)

print(summ4s)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1/3) * summ4s$coefficients[1,1])

wynik

```


```{r}
fit5s <- rq(diff_met~ -1 + n_,tau=.90, data = data_mets)
summ5s <- summary(fit5s)

print(summ5s)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1) * summ5s$coefficients[1,1])

wynik

```


```{r}
ggplot(data_mets, aes(x = n, y = diff_met)) + geom_point() + ggtitle('Roznica w metylacji od pokrycia') +
  stat_function(fun = function(x) {summ2s$coefficients[3,1] * x^2 + summ2s$coefficients[2,1] * x + summ2s$coefficients[1,1] }, col = 'red') + stat_function(fun = function(x){ summ1s$coefficients[2,1] * x + summ1s$coefficients[1,1] }, col = 'blue') + stat_function(fun = function(x){x^(-1/2) * summ3s$coefficients[1,1]} , col = 'green') + stat_function(fun = function(x){x^(-1/3) * summ4s$coefficients[1,1]} , col = 'brown') +
stat_function(fun = function(x){x^(-1) * summ5s$coefficients[1,1]} , col = 'grey') +
geom_line(data = quantile_90s, aes(x = n, y = q90, col = 'yellow'))  
  
```

## Podzia³ po gapach (max = 100), n <= 80

```{r}

data <- create_tiles(data, 100) 
data %>% group_by(tiles, group) %>% summarise(mean_met = mean(met), n = n(), n2 = n()*n(),
                                              n_sqrt = n()^(-1/2), n_sqrt3 = n()^(-1/3), n_ =n()^(-1)) %>% 
  spread(group, mean_met) %>% mutate(diff_met = abs(EK - EU)) %>% filter(n <= 80) -> data_met

data_met %>% group_by(n) %>% summarise(q90 = quantile(diff_met, probs = 0.9 )) -> quantile_90

head(data_met)

```


### Regresja z kwantylem 0.9

```{r}
fit1 <- rq(diff_met~n,tau=.90, data = data_met)
summ1 <- summary(fit1)

print(summ1)

wynik <- data.frame(n = 1:20, est = summ1$coefficients[1,1] + 1:20 * summ1$coefficients[2,1])
wynik
```


```{r}
fit2 <- rq(diff_met~n + n2,tau=.90, data = data_met)
summ2 <- summary(fit2)

print(summ2)

wynik <- data.frame(n = 1:20, est = summ2$coefficients[1,1] + 1:20 * summ2$coefficients[2,1] + (1:20)^2 * summ2$coefficients[3,1])

wynik

```



```{r}
fit3 <- rq(diff_met~ -1 + n_sqrt,tau=.90, data = data_met)
summ3 <- summary(fit3)

print(summ3)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1/2) * summ3$coefficients[1,1])

wynik

```


```{r}
fit4<- rq(diff_met~ -1 + n_sqrt3,tau=.90, data = data_met)
summ4 <- summary(fit4)

print(summ4)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1/3) * summ4$coefficients[1,1])

wynik

```


```{r}
fit5<- rq(diff_met~ -1 + n_,tau=.90, data = data_met)
summ5 <- summary(fit5)

print(summ5)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1) * summ5$coefficients[1,1])

wynik

```


```{r}
ggplot(data_met, aes(x = n, y = diff_met)) + geom_point() + ggtitle('Roznica w metylacji od pokrycia') +
  stat_function(fun = function(x) {summ2$coefficients[3,1] * x^2 + summ2$coefficients[2,1] * x + summ2$coefficients[1,1] }, col = 'red') + stat_function(fun = function(x){ summ1$coefficients[2,1] * x + summ1$coefficients[1,1] }, col = 'blue') + stat_function(fun = function(x){x^(-1/2) * summ3$coefficients[1,1]} , col = 'green') + stat_function(fun = function(x){x^(-1/3) * summ4$coefficients[1,1]} , col = 'brown') +
stat_function(fun = function(x){x^(-1) * summ5$coefficients[1,1]} , col = 'grey') +
geom_line(data = quantile_90, aes(x = n, y = q90, col = 'yellow'))  
  
```


## Podzia³ na regiony o d³ugoœci 1000


```{r}
data <- dataa
data %>% mutate(met = numCs/(numTs + numCs)) -> data
data$tiles = data$poz %/% 1000
data$tiles <- as.factor(data$tiles)

data %>% group_by(tiles, group, chr) %>% summarise(mean_met = mean(met), n = n(), n2 = n() * n(),
                                              n_sqrt = n()^(-1/2), n_sqrt3 = n()^(-1/3), n_ =n()^(-1)) %>% 
  spread(group, mean_met) %>% mutate(diff_met = abs(EK - EU)) -> data_met2

data_met2 %>% group_by(n) %>% summarise(q90 = quantile(diff_met, probs = 0.9 )) -> quantile_902

head(data_met2)


```



### Regresja z kwantylem 0.9


```{r}
fit12 <- rq(diff_met~n,tau=.90, data = data_met2)
summ12 <- summary(fit12)

print(summ12)

wynik <- data.frame(n = 1:20, est = summ12$coefficients[1,1] + 1:20 * summ12$coefficients[2,1])
wynik
```


```{r}
fit22 <- rq(diff_met~n + n2,tau=.90, data = data_met2)
summ22 <- summary(fit22)

print(summ22)

wynik <- data.frame(n = 1:20, est = summ22$coefficients[1,1] + 1:20 * summ22$coefficients[2,1] + (1:20)^2 * summ22$coefficients[3,1])

wynik

```

```{r}
fit32 <- rq(diff_met~ -1 + n_sqrt,tau=.90, data = data_met2)
summ32 <- summary(fit32)

print(summ32)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1/2) * summ32$coefficients[1,1])

wynik

```


```{r}
fit42<- rq(diff_met~ -1 + n_sqrt3,tau=.90, data = data_met2)
summ42 <- summary(fit42)

print(summ42)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1/3) * summ42$coefficients[1,1])

wynik

```


```{r}
fit52 <- rq(diff_met~ -1 + n_,tau=.90, data = data_met2)
summ52 <- summary(fit52)

print(summ52)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1) * summ52$coefficients[1,1])

wynik

```


```{r}
ggplot(data_met2, aes(x = n, y = diff_met)) + geom_point() + ggtitle('Roznica w metylacji od pokrycia') +
  stat_function(fun = function(x) {summ22$coefficients[3,1] * x^2 + summ22$coefficients[2,1] * x + summ22$coefficients[1,1] }, col = 'red') + stat_function(fun = function(x){ summ12$coefficients[2,1] * x + summ12$coefficients[1,1] }, col = 'blue') + stat_function(fun = function(x){x^(-1/2) * summ32$coefficients[1,1]} , col = 'green') + stat_function(fun = function(x){x^(-1/3) * summ42$coefficients[1,1]} , col = 'brown') +
stat_function(fun = function(x){x^(-1) * summ52$coefficients[1,1]} , col = 'grey') +
geom_line(data = quantile_902, aes(x = n, y = q90, col = 'yellow'))  
  
```



## Podzia³ po gapach (max = 100), n <= 80

```{r}

data %>% group_by(tiles, group) %>% summarise(mean_met = mean(met), n = n(), n2 = n()*n(),                                        n_sqrt = n()^(-1/2), n_sqrt3 = n()^(-1/3), n_ =n()^(-1)) %>% 
  spread(group, mean_met) %>% mutate(diff_met = abs(EK - EU)) %>% filter(n <= 80) -> data_metb

data_met %>% group_by(n) %>% summarise(q90 = quantile(diff_met, probs = 0.9 )) -> quantile_90b

head(data_metb)

```


### Regresja z kwantylem 0.9

```{r}
fit1b <- rq(diff_met~n,tau=.90, data = data_metb)
summ1b <- summary(fit1b)

print(summ1b)

wynik <- data.frame(n = 1:20, est = summ1b$coefficients[1,1] + 1:20 * summ1b$coefficients[2,1])
wynik
```


```{r}
fit2b <- rq(diff_met~n + n2,tau=.90, data = data_metb)
summ2b <- summary(fit2b)

print(summ2b)

wynik <- data.frame(n = 1:20, est = summ2b$coefficients[1,1] + 1:20 * summ2b$coefficients[2,1] + (1:20)^2 * summ2b$coefficients[3,1])

wynik

```



```{r}
fit3b <- rq(diff_met~ -1 + n_sqrt,tau=.90, data = data_metb)
summ3b <- summary(fit3b)

print(summ3b)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1/2) * summ3b$coefficients[1,1])

wynik

```


```{r}
fit4b<- rq(diff_met~ -1 + n_sqrt3,tau=.90, data = data_metb)
summ4b <- summary(fit4b)

print(summ4b)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1/3) * summ4b$coefficients[1,1])

wynik

```


```{r}
fit5b<- rq(diff_met~ -1 + n_,tau=.90, data = data_metb)
summ5b <- summary(fit5b)

print(summ5b)

wynik <- data.frame(n = 1:20, est =  (1:20)^(-1) * summ5b$coefficients[1,1])

wynik

```


```{r}
ggplot(data_metb, aes(x = n, y = diff_met)) + geom_point() + ggtitle('Roznica w metylacji od pokrycia') +
  stat_function(fun = function(x) {summ2b$coefficients[3,1] * x^2 + summ2b$coefficients[2,1] * x + summ2b$coefficients[1,1] }, col = 'red') + stat_function(fun = function(x){ summ1b$coefficients[2,1] * x + summ1b$coefficients[1,1] }, col = 'blue') + stat_function(fun = function(x){x^(-1/2) * summ3b$coefficients[1,1]} , col = 'green') + stat_function(fun = function(x){x^(-1/3) * summ4b$coefficients[1,1]} , col = 'brown') +
stat_function(fun = function(x){x^(-1) * summ5b$coefficients[1,1]} , col = 'grey') +
geom_line(data = quantile_90b, aes(x = n, y = q90, col = 'yellow'))  
  
```

